name: Shared Gitleaks Scan

on:
  # 1. ä»£ç æ¨é€åˆ°ä»»ä½•åˆ†æ”¯æ—¶è§¦å‘ï¼ˆæœ€å¸¸ç”¨çš„å®æ—¶æ‹¦æˆªï¼‰
  push:
    branches: [ "**" ] 
  
  # 2. æäº¤ Pull Request æ—¶è§¦å‘ï¼ˆé˜²æ­¢åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼‰
  pull_request:
  
  # 3. åˆå¹¶é˜Ÿåˆ—è§¦å‘ï¼ˆå¦‚æœä½¿ç”¨äº† GitHub Merge Queueï¼‰
  merge_group:

  # 4. æ–°å¢ï¼šå…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼ˆç”¨äºå®‰å…¨å®¡è®¡æˆ–æµ‹è¯•æ–°è§„åˆ™ï¼‰
  workflow_dispatch:

  workflow_call:
    # å…è®¸è°ƒç”¨æ–¹ä¼ å…¥å‚æ•°ï¼ˆå¯é€‰ï¼‰
    inputs:
      config_path:
        required: false
        type: string
        default: "./gitleaks.toml"
        description: "Path to gitleaks config file"
    secrets:
      # å¦‚æœéœ€è¦è®¿é—®ç§æœ‰ä»“åº“ä¸‹è½½é…ç½®ï¼Œå¯èƒ½éœ€è¦ Token
      ORG_PAT:
        required: false

jobs:
  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Gitleaks éœ€è¦å®Œæ•´çš„ git å†å²

      - name: Checkout Security Config
        uses: actions/checkout@v4
        with:
          repository: volcengine/security-ops # æ›¿æ¢ä¸ºä½ çš„ç»„ç»‡å/ä»“åº“å
          path: security-ops-config

      - name: Run Gitleaks
        id: gitleaks # æ·»åŠ  ID ä»¥ä¾¿åç»­æ­¥éª¤å¼•ç”¨çŠ¶æ€
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} 
          GITLEAKS_CONFIG: "security-ops-config/gitleaks.toml"

      # æ–°å¢ï¼šå½“æ‰«æå¤±è´¥æ—¶ï¼Œåœ¨ Actions æ‘˜è¦ä¸­æ˜¾ç¤ºå…·ä½“çš„è±å…æŒ‡å¼•
      - name: Report Gitleaks Failure
        if: failure() # ä»…åœ¨æ‰«æå¤±è´¥æ—¶è¿è¡Œ
        run: |
          # ä»…ä¿ç•™è¿™ä¸€è¡Œ Error Annotationï¼Œç”¨äºåœ¨æ–‡ä»¶å˜åŠ¨å¤„é«˜äº®æé†’
          echo "::error title=Gitleaks Scan Failed::å‘ç°æ½œåœ¨çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼"
          
          # å°†è¯¦ç»†è¯´æ˜è¾“å‡ºåˆ° Job Summary (æ”¯æŒ Markdown)
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ğŸš¨ Gitleaks Scan Failed
          å‘ç°æ½œåœ¨çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼è¯·æ£€æŸ¥ä»£ç ã€‚
          
          **é‡è¦æç¤ºï¼š** ä¸€æ—¦ç¡®è®¤å‘ç”Ÿæ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼Œåº”é»˜è®¤è¯¥ä¿¡æ¯å·²è¢«å…¬å¼€è®¿é—®ã€‚è¯·åŠ¡å¿…ç«‹å³é‡‡å–æ­¢æŸæªæ–½ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºè½®è½¬å¯†é’¥å’ŒåŠé”€è¯ä¹¦ã€‚

          ### å¦‚ä½•å¤„ç†è¯¯æŠ¥ (False Positive)?
          å¦‚æœç¡®è®¤æ˜¯è¯¯æŠ¥ï¼Œè¯·åœ¨ä»£ç ä¸­æ·»åŠ è±å…æ³¨é‡Šï¼š

          **æ–¹æ³• 1 (å•è¡Œ)ï¼š**
          \`\`\`javascript
          const token = 'fake'; // gitleaks:allow
          \`\`\`

          EOF
